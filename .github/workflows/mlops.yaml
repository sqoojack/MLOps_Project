name: MLOps Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    services:
      redis:
        image: redis
        ports:
          - 6379:6379

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python 3.9
      uses: actions/setup-python@v3
      with:
        python-version: 3.9

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest dvc

    # 1. 單元測試
    - name: Run Unit Tests
      run: |
        # 使用 python -m pytest 避免路徑問題
        python -m pytest tests/

    # 2. DVC 訓練流程
    - name: Run DVC Pipeline
      if: github.ref == 'refs/heads/main'
      # 這裡需要設定 DVC Remote 的憑證，例如 GDrive 或 S3
      # 為了 Demo，這裡假設是 Local 執行，不 pull 遠端資料
      run: |
        # 如果有遠端數據：
        # dvc remote modify myremote --local gdrive_service_account_json_file_path ...
        # dvc pull 
        dvc repro

    # 3. 顯示結果指標
    - name: Show Metrics
      if: github.ref == 'refs/heads/main'
      run: |
        cat metrics.json

    # 4. 模型註冊與晉升 (Model Registry & Promotion)
    # 這是原本缺失的部分
    - name: Promote Model to Production
      if: github.ref == 'refs/heads/main'
      env:
        MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }} # 指向你的 MLflow Server
      run: |
        # 建立一個簡單的 Python script 來執行註冊
        cat <<EOF > promote_model.py
        import mlflow
        from mlflow.tracking import MlflowClient
        
        # 假設我們在 params.yaml 定義了模型名稱
        import yaml
        with open("params.yaml") as f:
            params = yaml.safe_load(f)
            
        model_name = params['mlflow']['model_name']
        client = MlflowClient()
        
        # 搜尋這個實驗下最新的 Run
        experiment = client.get_experiment_by_name(params['mlflow']['experiment_name'])
        runs = client.search_runs(
            experiment_ids=[experiment.experiment_id],
            order_by=["metrics.ndcg_10 DESC"], # 依據 NDCG 排序
            max_results=1
        )
        
        best_run = runs[0]
        print(f"Best run id: {best_run.info.run_id}, NDCG: {best_run.data.metrics['ndcg_10']}")
        
        # 註冊模型
        model_uri = f"runs:/{best_run.info.run_id}/model"
        mv = client.create_model_version(model_name, model_uri, best_run.info.run_id)
        
        # 晉升為 Production (Transition to Production)
        client.transition_model_version_stage(
            name=model_name,
            version=mv.version,
            stage="Production",
            archive_existing_versions=True
        )
        print(f"Model version {mv.version} promoted to Production.")
        EOF
        
        # 執行腳本 (注意：如果沒有設定真實的 MLflow Server，這一步在 CI 會失敗，需註解掉或 mock)
        # python promote_model.py